<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUVERA ë§¤ì¶œ ë¶„ì„ AI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .chat-bubble-ai {
            background-color: #ffffff; /* white */
            color: #1f2937; /* gray-800 */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl flex flex-col lg:flex-row overflow-hidden" style="height: 80vh; min-height: 600px;">

        <!-- 1. ì‚¬ì´ë“œë°” (ë°ì´í„° ì—°ê²°) -->
        <div class="w-full lg:w-1/3 bg-gray-50 border-b lg:border-r border-gray-200 p-6 flex flex-col">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">ë§¤ì¶œ ë¶„ì„ AI</h1>
            
            <!-- 1-1. ì¸ì¦ ë‹¨ê³„ -->
            <div id="auth-section">
                <p class="text-gray-600 mb-4 text-sm">ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ Google Sheets ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <button id="authorize_button" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition duration-300">
                    Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
                <button id="signout_button" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg mt-2 hover:bg-gray-300 transition duration-300 hidden">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>

            <!-- 1-2. ë°ì´í„° ì…ë ¥ ë‹¨ê³„ (ì¸ì¦ í›„ í‘œì‹œ) -->
            <div id="data-section" class="hidden mt-6 space-y-4">
                <div>
                    <label for="sheet-id" class="block text-sm font-medium text-gray-700 mb-1">Google Sheet ID</label>
                    <input type="text" id="sheet-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì‹œíŠ¸ URLì˜ /d/.../ ë¶€ë¶„">
                    <p class="text-xs text-gray-500 mt-1">ì˜ˆ: .../d/1aBcD_.../edit</p>
                </div>
                <div>
                    <label for="sheet-range" class="block text-sm font-medium text-gray-700 mb-1">ì‹œíŠ¸ ì´ë¦„ (ë²”ìœ„)</label>
                    <input type="text" id="sheet-range" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ: 'Sheet1' ë˜ëŠ” 'Sheet1!A1:D10'">
                    <p class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: 'Sheet1'</small>
                </div>
                <button id="fetch_button" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition duration-300">
                    ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>

            <!-- 1-3. ìƒíƒœ ë©”ì‹œì§€ -->
            <div id="status-message" class="mt-auto pt-4 text-sm text-gray-600">
                <p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>

        <!-- 2. ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ -->
        <div class="w-full lg:w-2/3 flex flex-col bg-gray-100 h-full">
            
            <!-- 2-1. ì±„íŒ…ì°½ -->
            <div id="chat-window" class="flex-1 p-6 space-y-4 overflow-y-auto">
                <!-- AI ê¸°ë³¸ ì¸ì‚¬ -->
                <div class="flex justify-start">
                    <div class="chat-bubble-ai max-w-lg p-3 rounded-lg shadow">
                        <p>ì•ˆë…•í•˜ì„¸ìš”! JUVERA ë§¤ì¶œ ë¶„ì„ AIì…ë‹ˆë‹¤. ë¨¼ì € Google Sheets ë°ì´í„°ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”. ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.</p>
                    </div>
                </div>
                <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- 2-2. ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="loading-indicator" class="hidden p-6 text-center">
                <div class="inline-flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-600">ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
            </div>

            <!-- 2-3. ì±„íŒ… ì…ë ¥ì°½ -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <div class="flex space-x-3">
                    <input type="text" id="chat-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                    <button id="send-button" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-300 disabled:bg-gray-400" disabled>
                        ì „ì†¡
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. ì„¤ì • ë³€ìˆ˜ (ì¤‘ìš”!) ---
        //
        // â¬‡ï¸ â¬‡ï¸ â¬‡ï¸  ì—¬ê¸°ì— ëŒ€í‘œë‹˜ì´ ë°œê¸‰ë°›ì€ 3ê°œì˜ í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â¬‡ï¸ â¬‡ï¸ â¬‡ï¸
        //
        // TODO: Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ 'API í‚¤'ì™€ 'í´ë¼ì´ì–¸íŠ¸ ID'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        // ë˜í•œ 'Google Sheets API'ì™€ 'Gemini API'ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.

        // 1. Google API í‚¤ (Google Cloud Consoleì—ì„œ 'API í‚¤'ë¡œ ìƒì„±í•œ ê°’)
        // ğŸš¨ğŸš¨ğŸš¨ ì˜¤ë¥˜ ë°œìƒ! ğŸš¨ğŸš¨ğŸš¨
        // [ì˜¤í›„ 03:03:58] API key not valid
        // ì´ ì˜¤ë¥˜ëŠ” ì•„ë˜ì˜ GOOGLE_API_KEY ê°’ì´ ìœ íš¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí–ˆìŠµë‹ˆë‹¤.
        // Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ 'API í‚¤' (AIzaSy... ë¡œ ì‹œì‘í•˜ëŠ” ê°’)ë¥¼
        // ì•„ë˜ ëŒ€ê´„í˜¸ì™€ ë”°ì˜´í‘œ ì•ˆì— ì •í™•íˆ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.
        const GOOGLE_API_KEY = "AIzaSyCZkrtMHiPoMqjnz8v48iM3iyrqQP8TFA4";

        // 2. Google í´ë¼ì´ì–¸íŠ¸ ID (Google Cloud Consoleì—ì„œ 'ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜' ìœ í˜•ìœ¼ë¡œ ìƒì„±í•œ 'í´ë¼ì´ì–¸íŠ¸ ID')
        // ğŸš¨ğŸš¨ğŸš¨ '400. ìš”ì²­ í˜•ì‹ì´ ì˜ëª»ë˜ì–´...' ì˜¤ë¥˜ ğŸš¨ğŸš¨ğŸš¨
        // [ì˜¤í›„ 03:06:00] ì´ ì˜¤ë¥˜ëŠ” 'Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë°œìƒí•˜ë©°,
        // ì•„ë˜ì˜ GOOGLE_CLIENT_ID ê°’ì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
        // Google Cloud Consoleì—ì„œ 'ì›¹ í´ë¼ì´ì–¸íŠ¸ 1'ì˜ ID (1234... ë¡œ ì‹œì‘í•˜ëŠ” ê°’)ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
        const GOOGLE_CLIENT_ID = "123418830267-1qus5o2ko22j4be9sre5elo5ldilmm5k.apps.googleusercontent.com";
        
        // 3. Gemini API í‚¤ (Google AI Studioì—ì„œ 'Get API key'ë¡œ ìƒì„±í•œ ê°’)
        // (Google Cloudì˜ Vertex AI Gemini APIë¥¼ ì‚¬ìš©í•œë‹¤ë©´ GOOGLE_API_KEYì™€ ë™ì¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
        // ğŸš¨ ì´ ê°’ë„ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
        const GEMINI_API_KEY = "AIzaSyCksneX9qmrw_ytKxa4cxP7f2YoWrr5rm4";

        // â¬†ï¸ â¬†ï¸ â¬†ï¸  ì—¬ê¸°ê¹Œì§€ 3ê°œì˜ í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš” â¬†ï¸ â¬†ï¸ â¬†ï¸
        //

        // Google API ìŠ¤ì½”í”„ (Google Sheets ì½ê¸° ì „ìš©)
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

        // --- 2. ì „ì—­ ë³€ìˆ˜ ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let sheetData = null; // ë¶ˆëŸ¬ì˜¨ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì €ì¥ (CSV ë¬¸ìì—´ í˜•ì‹)
        let sheetHeaders = []; // ì‹œíŠ¸ì˜ í—¤ë”(ì»¬ëŸ¼ëª…) ì €ì¥

        // --- 3. UI ìš”ì†Œ ---
        const authorizeButton = document.getElementById("authorize_button");
        const signoutButton = document.getElementById("signout_button");
        const dataSection = document.getElementById("data-section");
        const fetchButton = document.getElementById("fetch_button");
        const statusMessage = document.getElementById("status-message");
        const chatInput = document.getElementById("chat-input");
        const sendButton = document.getElementById("send-button");
        const chatWindow = document.getElementById("chat-window");
        const loadingIndicator = document.getElementById("loading-indicator");
        const sheetIdInput = document.getElementById("sheet-id");
        const sheetRangeInput = document.getElementById("sheet-range");

        // --- 4. Google API ì´ˆê¸°í™” ---

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘
        window.onload = () => {
            gapi.load('client', initializeGapiClient);
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '', // ì½œë°±ì€ ìš”ì²­ ì‹œ ë™ì ìœ¼ë¡œ ì„¤ì •
            });
            gisInited = true;
            checkAuthButtonStatus();
        };

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GOOGLE_API_KEY,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            });
            gapiInited = true;
            checkAuthButtonStatus();
        }

        function checkAuthButtonStatus() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
            }
        }

        // --- 5. ì¸ì¦ ë¡œì§ ---
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;

        function handleAuthClick() {
            tokenClient.callback = (resp) => {
                if (resp.error) {
                    throw (resp);
                }
                updateSigninStatus(true);
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    updateSigninStatus(false);
                });
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.classList.add("hidden");
                signoutButton.classList.remove("hidden");
                dataSection.classList.remove("hidden");
                statusMessage.innerHTML = '<p class="text-green-600 font-medium">Google ê³„ì • ì¸ì¦ ì™„ë£Œ!</p><p>ì´ì œ Sheet ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>';
            } else {
                authorizeButton.classList.remove("hidden");
                signoutButton.classList.add("hidden");
                dataSection.classList.add("hidden");
                chatInput.disabled = true;
                sendButton.disabled = true;
                sheetData = null;
                sheetHeaders = [];
                statusMessage.innerHTML = "<p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>";
                addMessageToChat("AI", "Google ê³„ì • ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.");
            }
        }

        // --- 6. Google Sheets ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
        fetchButton.onclick = loadSheetData;

        async function loadSheetData() {
            const sheetId = sheetIdInput.value.trim();
            let range = sheetRangeInput.value.trim();

            if (!sheetId) {
                statusMessage.innerHTML = '<p class="text-red-600 font-medium">Sheet IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
                return;
            }
            if (!range) {
                range = "Sheet1"; // ê¸°ë³¸ ì‹œíŠ¸ ì´ë¦„
            }

            statusMessage.innerHTML = '<p class="text-blue-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: sheetId,
                    range: range,
                });

                const values = response.result.values;

                if (values && values.length > 0) {
                    // ë°ì´í„°ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜
                    sheetData = values.map(row => 
                        row.map(cell => {
                            // ì…€ ë‚´ìš©ì— ì‰¼í‘œë‚˜ ë”°ì˜´í‘œê°€ ìˆìœ¼ë©´ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                            let newCell = cell.toString();
                            if (newCell.includes(",")) {
                                newCell = `"${newCell}"`;
                            }
                            return newCell;
                        }).join(",")
                    ).join("\n");
                    
                    sheetHeaders = values[0]; // ì²« ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ì €ì¥

                    statusMessage.innerHTML = `<p class="text-green-600 font-medium">ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ!</p><p>${values.length}ê°œ í–‰, ${sheetHeaders.length}ê°œ ì»¬ëŸ¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    addMessageToChat("AI", `ë°ì´í„° ë¡œë“œ ì™„ë£Œ! <strong>'${range}'</strong> ì‹œíŠ¸ì—ì„œ ì´ ${values.length}ê°œì˜ í–‰ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì´ì œ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.`);
                    
                    // í—¤ë” ì •ë³´(ì»¬ëŸ¼ëª…)ë¥¼ AIì—ê²Œ ì•Œë ¤ì£¼ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
                    addMessageToChat("AI", `ë¶„ì„ ê°€ëŠ¥í•œ ì»¬ëŸ¼: ${sheetHeaders.join(', ')}`);

                } else {
                    statusMessage.innerHTML = '<p class="text-red-600 font-medium">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><p>ì‹œíŠ¸ IDì™€ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                    sheetData = null;
                    sheetHeaders = [];
                }
            } catch (err) {
                console.error("Execute error", err);
                statusMessage.innerHTML = `<p class="text-red-600 font-medium">ì˜¤ë¥˜ ë°œìƒ:</p><p class="text-xs">${err.result.error.message}</p>`;
                sheetData = null;
                sheetHeaders = [];
            }
        }

        // --- 7. ì±„íŒ… ë¡œì§ ---
        sendButton.onclick = handleSendMessage;
        chatInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !chatInput.disabled) {
                handleSendMessage();
            }
        };

        function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;
            
            if (!sheetData) {
                addMessageToChat("AI", "ë¨¼ì € Google Sheets ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.");
                return;
            }

            addMessageToChat("user", userQuery);
            chatInput.value = "";
            loadingIndicator.classList.remove("hidden");
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Gemini API í˜¸ì¶œ
            callGeminiAPI(userQuery);
        }

        function addMessageToChat(sender, message) {
            const bubble = document.createElement("div");
            bubble.classList.add("flex");

            if (sender === "user") {
                bubble.classList.add("justify-end");
                bubble.innerHTML = `<div class="chat-bubble-user max-w-lg p-3 rounded-lg shadow"><p>${message}</p></div>`;
            } else {
                bubble.classList.add("justify-start");
                bubble.innerHTML = `<div class="chat-bubble-ai max-w-lg p-3 rounded-lg shadow"><p>${message}</p></div>`;
            }
            
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- 8. Gemini API í˜¸ì¶œ (Exponential Backoff í¬í•¨) ---
        
        async function callGeminiAPI(userQuery, retryCount = 0, maxRetries = 5, baseDelay = 1000) {
            
            const systemPrompt = `ë‹¹ì‹ ì€ 'JUVERA'ë¼ëŠ” í™”ì¥í’ˆ ë¸Œëœë“œë¥¼ ìœ„í•œ ì „ë¬¸ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì•„ë˜ì— ì œê³µë˜ëŠ” CSV í˜•ì‹ì˜ ë§¤ì¶œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[ê·œì¹™]
1.  ë‹µë³€ì€ í•­ìƒ í•œêµ­ì–´ë¡œ, ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì œê³µí•´ì£¼ì„¸ìš”.
2.  ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‚¬ì‹¤ë§Œì„ ë§í•´ì•¼ í•©ë‹ˆë‹¤. ì¶”ì¸¡ì´ë‚˜ ë°ì´í„°ì— ì—†ëŠ” ì •ë³´ëŠ” ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”.
3.  ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì„ ë°ì´í„°ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°, "ë°ì´í„°ì—ì„œ í•´ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."ë¼ê³  ì •ì¤‘í•˜ê²Œ ë§í•´ì£¼ì„¸ìš”.
4.  ìˆ«ì ë°ì´í„°(ë§¤ì¶œ, ìˆ˜ëŸ‰ ë“±)ë¥¼ ì–¸ê¸‰í•  ë•ŒëŠ” ë‹¨ìœ„ë¥¼ ëª…í™•íˆ í•˜ê³ , ì²œ ë‹¨ìœ„ ì½¤ë§ˆ(,)ë¥¼ ì°ì–´ì£¼ì„¸ìš”.
5.  ê³„ì‚°ì´ í•„ìš”í•œ ê²½ìš° (ì˜ˆ: "ì´ ë§¤ì¶œ", "í‰ê·  íŒë§¤ê°€"), ê³„ì‚°ì„ ìˆ˜í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë‹µë³€í•˜ì„¸ìš”.
6.  ì»¬ëŸ¼(í—¤ë”) ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: ${sheetHeaders.join(', ')}

ì´ì œ, ì•„ë˜ì˜ ë°ì´í„°ì™€ ì§ˆë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
`;

            const fullPrompt = `${systemPrompt}\n[ë°ì´í„° (CSV í˜•ì‹)]\n${sheetData}\n\n[ì‚¬ìš©ì ì§ˆë¬¸]\n${userQuery}`;
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [{ 
                    parts: [{ text: fullPrompt }] 
                }],
                // systemInstruction: { 
                //     parts: [{ text: systemPrompt }] 
                // } // systemInstructionì´ ë” ë‚˜ì„ ìˆ˜ ìˆìœ¼ë‚˜, flash ëª¨ë¸ì€ contentsì— í•¨ê»˜ ë„£ëŠ” ê²ƒì´ ì•ˆì •ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // API ì—ëŸ¬ (ì˜ˆ: 429 Too Many Requests)
                    if (response.status === 429 && retryCount < maxRetries) {
                        const delay = baseDelay * Math.pow(2, retryCount) + Math.random() * 1000;
                        console.warn(`Rate limit. Retrying in ${delay}ms... (Attempt ${retryCount + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(userQuery, retryCount + 1);
                    }
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                let aiResponse = "ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    aiResponse = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                     aiResponse = `ë‹µë³€ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‚¬ìœ : ${result.promptFeedback.blockReason})`;
                }

                loadingIndicator.classList.add("hidden");
                addMessageToChat("AI", aiResponse.replace(/\n/g, '<br>')); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬

            } catch (error) {
                console.error("Gemini API call failed:", error);
                
                // ì¬ì‹œë„ ë¡œì§ (ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“±)
                if (retryCount < maxRetries) {
                    const delay = baseDelay * Math.pow(2, retryCount) + Math.random() * 1000;
                    console.warn(`Network error. Retrying in ${delay}ms... (Attempt ${retryCount + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(userQuery, retryCount + 1);
                }

                loadingIndicator.classList.add("hidden");
                addMessageToChat("AI", `ì£„ì†¡í•©ë‹ˆë‹¤. API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

    </script>
</body>
</html>




